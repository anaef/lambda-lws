#!/usr/bin/env bash
set -euo pipefail

# region
export AWS_REGION="eu-central-1"

# names
REPO="lambda-lws"                    # ECR repo to hold this image family
FUNC_NAME="lambda-lws-examples-raw"  # Lambda function name
IMAGE="lambda-lws-examples-raw"      # local image to push
IMAGE_TAG="$(date -u +%Y%m%d-%H%M%S)"

ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
ECR_URI="${ECR_REGISTRY}/${REPO}:${IMAGE_TAG}"

# ensure ECR repo exists
aws ecr describe-repositories --repository-names "${REPO}" --region "${AWS_REGION}" >/dev/null 2>&1 \
	|| aws ecr create-repository --repository-name "${REPO}" --image-scanning-configuration scanOnPush=true --region "${AWS_REGION}" >/dev/null

# login to ECR
aws ecr get-login-password --region "${AWS_REGION}" \
	| docker login --username AWS --password-stdin "${ECR_REGISTRY}"

# build the exact compose target and push to ECR
docker compose build ${IMAGE}
docker tag lambda-lws/${IMAGE}:latest "${ECR_URI}"
docker push "${ECR_URI}"

# reuse/create execution role
ROLE_ARN="$(aws iam get-role --role-name lambda-basic-execution --query Role.Arn --output text 2>/dev/null || true)"
if [ -z "${ROLE_ARN}" ]; then
	cat > trust-policy.json <<'JSON'
{ "Version":"2012-10-17", "Statement":[{ "Effect":"Allow", "Principal":{"Service":"lambda.amazonaws.com"}, "Action":"sts:AssumeRole"}]}
JSON
	aws iam create-role --role-name lambda-basic-execution --assume-role-policy-document file://trust-policy.json >/dev/null
	aws iam attach-role-policy --role-name lambda-basic-execution \
		--policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole >/dev/null
	ROLE_ARN="$(aws iam get-role --role-name lambda-basic-execution --query Role.Arn --output text)"
fi

# create or update the Lambda function
aws lambda create-function \
	--function-name "$FUNC_NAME" \
	--package-type Image \
	--code ImageUri="$ECR_URI" \
	--role "$ROLE_ARN" \
	--region "$AWS_REGION" >/dev/null 2>&1 || {
	aws lambda update-function-code \
		--function-name "$FUNC_NAME" \
		--image-uri "$ECR_URI" \
		--region "$AWS_REGION" >/dev/null
	aws lambda wait function-updated \
		--function-name "$FUNC_NAME" \
		--region "$AWS_REGION" >/dev/null
}

echo "Deployed ${FUNC_NAME} with image ${ECR_URI}"
